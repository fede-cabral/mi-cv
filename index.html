<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORJAX Terminal - Global Forex</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: { 
                        dark: '#0f172a',
                        primary: '#3b82f6',
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap');
        
        body { font-family: 'Outfit', sans-serif; transition: all 0.3s ease; }
        
        /* Glassmorphism Premium */
        .glass { backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .dark .glass { background: rgba(15, 23, 42, 0.7); border-color: rgba(255,255,255,0.05); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        .light .glass { background: rgba(255, 255, 255, 0.8); border-color: rgba(0,0,0,0.05); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }

        .hover-scale:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.2); }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .dark input, .dark select { background: #1e293b; color: #fff; border: 1px solid #334155; }
        .dark input::placeholder { color: #94a3b8; }
        .light input, .light select { background: #f1f5f9; color: #1e293b; border: 1px solid #cbd5e1; }
    </style>
</head>

<body class="min-h-screen pb-10 transition-colors duration-500 bg-slate-100 text-slate-900 dark:bg-[#0B1121] dark:text-slate-100 selection:bg-blue-500 selection:text-white">

<div id="loginScreen" class="fixed inset-0 z-[60] flex items-center justify-center bg-[#0B1121] transition-all duration-500">
    <div class="relative w-full max-w-md p-8 text-center fade-in">
        <div class="absolute inset-0 bg-blue-600/20 blur-[100px] rounded-full"></div>
        <div class="glass relative p-10 rounded-3xl border border-white/10">
            <div class="mb-8 inline-flex p-5 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-2xl shadow-2xl shadow-blue-600/20">
                <i data-lucide="layout-dashboard" class="w-10 h-10 text-white"></i>
            </div>
            <h2 class="text-4xl font-extrabold mb-2 tracking-tight">FORJAX <span class="text-blue-500">TERMINAL</span></h2>
            <p class="text-slate-400 mb-8 font-medium">Sistema de Inteligencia Financiera</p>
            <input id="userInput" type="text" placeholder="Identificaci贸n de Agente" class="w-full p-4 rounded-xl mb-4 text-center text-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all">
            <button onclick="app.initSession()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg hover:shadow-blue-600/40">ACCEDER</button>
        </div>
    </div>
</div>

<div id="mainApp" class="hidden opacity-0 transition-opacity duration-700">
    
    <nav class="fixed top-6 left-1/2 -translate-x-1/2 z-50 glass px-2 py-2 rounded-2xl flex items-center gap-1 shadow-2xl">
        <button onclick="app.switchTab('wallet')" id="btnWallet" class="px-6 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all bg-blue-600 text-white shadow-lg">
            <i data-lucide="wallet"></i> Mi Billetera
        </button>
        <button onclick="app.switchTab('market')" id="btnMarket" class="px-6 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all text-slate-400 hover:text-white hover:bg-white/5">
            <i data-lucide="globe"></i> Forex Global
        </button>
        <div class="w-px h-6 bg-white/10 mx-2"></div>
        <button onclick="app.toggleTheme()" class="p-2.5 rounded-xl text-slate-400 hover:text-yellow-400 hover:bg-white/5 transition-all">
            <i id="themeIcon" data-lucide="sun" class="w-5 h-5"></i>
        </button>
        <button onclick="app.logout()" class="p-2.5 rounded-xl text-slate-400 hover:text-rose-500 hover:bg-white/5 transition-all">
            <i data-lucide="power" class="w-5 h-5"></i>
        </button>
    </nav>

    <div class="pt-28 max-w-[1400px] mx-auto px-6 pb-12">
        
        <div id="viewWallet" class="fade-in">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="glass p-6 rounded-3xl border-b-4 border-emerald-500 hover-scale">
                    <p class="text-xs font-bold uppercase tracking-wider opacity-60 mb-1">Ingresos Totales</p>
                    <h2 class="text-3xl font-black text-emerald-500" id="bIncome">$0</h2>
                </div>
                <div class="glass p-6 rounded-3xl border-b-4 border-rose-500 hover-scale">
                    <p class="text-xs font-bold uppercase tracking-wider opacity-60 mb-1">Gastos Totales</p>
                    <h2 class="text-3xl font-black text-rose-500" id="bExpense">$0</h2>
                </div>
                <div class="glass p-6 rounded-3xl border-b-4 border-blue-500 hover-scale">
                    <p class="text-xs font-bold uppercase tracking-wider opacity-60 mb-1">Balance Neto</p>
                    <h2 class="text-3xl font-black text-blue-500" id="bNet">$0</h2>
                </div>
                <div class="glass p-6 rounded-3xl border-b-4 border-violet-500 hover-scale flex flex-col justify-center">
                    <p class="text-xs font-bold uppercase tracking-wider opacity-60 mb-1">Capital en USD</p>
                    <div class="flex items-baseline gap-2">
                        <h2 class="text-3xl font-black text-white" id="capitalUsd">US$ 0</h2>
                        <span class="text-xs text-emerald-400 font-bold bg-emerald-500/10 px-2 py-1 rounded" id="dolarRateTag">...</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 space-y-6">
                    <div class="glass p-6 rounded-3xl">
                        <h3 class="flex items-center gap-2 text-lg font-bold mb-6 text-blue-500"><i data-lucide="mouse-pointer-2"></i> Operaciones</h3>
                        
                        <div class="space-y-4">
                            <div class="relative">
                                <i data-lucide="type" class="absolute left-4 top-3.5 w-5 h-5 opacity-50"></i>
                                <input id="transDesc" type="text" placeholder="Descripci贸n (ej: Sueldo, Super)" class="w-full pl-12 p-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                            </div>
                            
                            <div class="flex gap-3">
                                <div class="relative w-1/2">
                                    <i data-lucide="dollar-sign" class="absolute left-3 top-3.5 w-5 h-5 opacity-50"></i>
                                    <input id="transAmount" type="number" placeholder="Monto" class="w-full pl-10 p-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                                </div>
                                <select id="transCategory" class="w-1/2 p-3 rounded-xl font-medium outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
                                    <option value="Ingreso"> Ingreso</option>
                                    <option value="Hogar"> Hogar</option>
                                    <option value="Comida"> Comida</option>
                                    <option value="Servicios"> Servicios</option>
                                    <option value="Transporte"> Transporte</option>
                                    <option value="Ocio"> Ocio</option>
                                    <option value="Salud">わ Salud</option>
                                    <option value="Educaci贸n"> Educaci贸n</option>
                                    <option value="Otros"> Otros</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-3 pt-2">
                                <button onclick="app.addRecord('income')" class="bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold transition-all shadow-lg hover:shadow-emerald-500/30 active:scale-95 flex justify-center items-center gap-2">
                                    <i data-lucide="plus"></i> INGRESO
                                </button>
                                <button onclick="app.addRecord('expense')" class="bg-rose-600 hover:bg-rose-500 text-white py-3 rounded-xl font-bold transition-all shadow-lg hover:shadow-rose-500/30 active:scale-95 flex justify-center items-center gap-2">
                                    <i data-lucide="minus"></i> GASTO
                                </button>
                            </div>
                        </div>

                        <div class="mt-10 pt-8 border-t border-white/10">
                            <div class="flex justify-between items-end mb-4">
                                <div>
                                    <h4 class="font-bold text-base text-blue-400 uppercase tracking-wide flex items-center gap-2">
                                        <i data-lucide="target" class="w-5 h-5"></i> Presupuesto
                                    </h4>
                                    <p class="text-xs text-slate-500 mt-1">Progreso mensual</p>
                                </div>
                                <span id="budgetPercent" class="text-xl font-black text-white bg-blue-600 px-3 py-1 rounded-lg shadow-lg shadow-blue-600/20">0%</span>
                            </div>
                            
                            <div class="w-full bg-slate-700/50 rounded-full h-5 mb-4 overflow-hidden border border-white/5">
                                <div id="budgetBar" class="bg-blue-500 h-5 rounded-full transition-all duration-1000 relative" style="width: 0%">
                                    <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between bg-black/20 p-3 rounded-xl border border-white/5">
                                <span id="budgetUsed" class="text-sm font-bold text-rose-400">$0 Gastados</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-slate-400">Meta:</span>
                                    <input id="budgetInput" onchange="app.setBudget()" type="number" class="bg-transparent text-right outline-none w-32 text-lg font-bold text-emerald-400 placeholder-slate-600 focus:border-b focus:border-emerald-400 transition-all" placeholder="$ Definir">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass p-5 rounded-3xl">
                            <h4 class="text-xs font-bold uppercase tracking-wider opacity-60 mb-4">Evoluci贸n</h4>
                            <div class="h-48"><canvas id="barChart"></canvas></div>
                        </div>
                        <div class="glass p-5 rounded-3xl">
                            <h4 class="text-xs font-bold uppercase tracking-wider opacity-60 mb-4">Distribuci贸n</h4>
                            <div class="h-48 flex justify-center"><canvas id="pieChart"></canvas></div>
                        </div>
                    </div>

                    <div class="glass rounded-3xl overflow-hidden border border-white/5">
                        <div class="p-5 border-b border-white/5 flex flex-wrap justify-between items-center gap-4 bg-white/5">
                            <h3 class="font-bold flex items-center gap-2"><i data-lucide="list"></i> Movimientos</h3>
                            <div class="flex gap-2">
                                <input id="searchInput" onkeyup="app.render()" type="text" placeholder="Buscar..." class="bg-black/20 border-none rounded-lg px-3 py-1.5 text-sm w-32 focus:w-48 transition-all outline-none">
                                <button onclick="app.exportProExcel()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-emerald-600/20">
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> EXCEL CFO
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto max-h-[400px] custom-scroll">
                            <table class="w-full text-left border-collapse">
                                <thead class="sticky top-0 bg-[#0f172a] z-10 text-xs uppercase opacity-70 font-bold">
                                    <tr>
                                        <th class="px-6 py-4">Fecha</th>
                                        <th class="px-6 py-4">Detalle</th>
                                        <th class="px-6 py-4">Categor铆a</th>
                                        <th class="px-6 py-4 text-right">Monto</th>
                                        <th class="px-6 py-4 text-center">Acci贸n</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTable" class="divide-y divide-white/5 text-sm font-medium"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="viewMarket" class="hidden fade-in">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-3xl font-black tracking-tight text-white flex items-center gap-2">
                        <i data-lucide="globe-2" class="text-blue-500"></i> Mercado Internacional
                    </h2>
                    <p class="text-slate-400">Cotizaciones vs D贸lar (USD)</p>
                </div>
                <div class="text-right">
                    <button onclick="app.fetchFullMarket()" class="bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 p-3 rounded-xl transition-all">
                        <i data-lucide="refresh-cw" id="refreshIcon" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <h3 class="text-xl font-bold text-white mb-4 pl-2 border-l-4 border-emerald-500"> Argentina</h3>
            <div id="marketGridArg" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="col-span-full text-center py-10">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-emerald-500"></div>
                </div>
            </div>

            <h3 class="text-xl font-bold text-white mb-4 pl-2 border-l-4 border-blue-500"> Divisas Mundiales (Forex)</h3>
            <div id="marketGridWorld" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                 </div>
        </div>

    </div>
</div>

<script>
/* ====================== CORE DEL SISTEMA ====================== */
const app = {
    user: localStorage.getItem("currentUser"),
    theme: localStorage.getItem("theme") || 'dark',
    currentTab: 'wallet',
    data: { records: [], budget: 0 },
    charts: {},

    init() {
        this.applyTheme();
        if (!this.user) {
            document.getElementById("loginScreen").classList.remove("hidden");
        } else {
            document.getElementById("loginScreen").classList.add("hidden");
            document.getElementById("mainApp").classList.remove("hidden");
            setTimeout(() => document.getElementById("mainApp").classList.remove("opacity-0"), 100);
            
            this.loadData();
            this.render();
            this.fetchDolarSimple();
            this.fetchFullMarket();
            lucide.createIcons();
        }
    },

    switchTab(tab) {
        this.currentTab = tab;
        const walletView = document.getElementById("viewWallet");
        const marketView = document.getElementById("viewMarket");
        const btnWallet = document.getElementById("btnWallet");
        const btnMarket = document.getElementById("btnMarket");

        if (tab === 'wallet') {
            walletView.classList.remove("hidden");
            marketView.classList.add("hidden");
            btnWallet.className = "px-6 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all bg-blue-600 text-white shadow-lg";
            btnMarket.className = "px-6 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all text-slate-400 hover:text-white hover:bg-white/5";
        } else {
            walletView.classList.add("hidden");
            marketView.classList.remove("hidden");
            btnWallet.className = "px-6 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all text-slate-400 hover:text-white hover:bg-white/5";
            btnMarket.className = "px-6 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-all bg-blue-600 text-white shadow-lg";
            this.fetchFullMarket();
        }
    },

    loadData() {
        const prefix = this.user + "_";
        this.data.records = JSON.parse(localStorage.getItem(prefix + "records")) || [];
        this.data.budget = Number(localStorage.getItem(prefix + "budget")) || 0;
    },

    save() {
        const prefix = this.user + "_";
        localStorage.setItem(prefix + "records", JSON.stringify(this.data.records));
        localStorage.setItem(prefix + "budget", this.data.budget);
        this.render();
    },

    addRecord(type) {
        const desc = document.getElementById("transDesc").value;
        const amount = Number(document.getElementById("transAmount").value);
        const category = document.getElementById("transCategory").value;

        if (!desc || amount <= 0) return Swal.fire({toast:true, position:'top', icon:'warning', title:'Faltan datos', showConfirmButton:false, timer:2000});

        this.data.records.unshift({ id: Date.now(), date: new Date().toLocaleDateString(), desc, amount, category, type });
        document.getElementById("transDesc").value = "";
        document.getElementById("transAmount").value = "";
        this.save();
        
        const Toast = Swal.mixin({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
        Toast.fire({ icon: 'success', title: 'Operaci贸n Registrada' });
    },

    deleteRecord(id) {
        this.data.records = this.data.records.filter(r => r.id !== id);
        this.save();
    },

    setBudget() {
        this.data.budget = Number(document.getElementById("budgetInput").value);
        this.save();
    },

    render() {
        const formatter = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 });
        const totalInc = this.data.records.filter(r => r.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
        const totalExp = this.data.records.filter(r => r.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);
        const balance = totalInc - totalExp;
        
        document.getElementById("bIncome").textContent = formatter.format(totalInc);
        document.getElementById("bExpense").textContent = formatter.format(totalExp);
        document.getElementById("bNet").textContent = formatter.format(balance);
        document.getElementById("bNet").className = `text-3xl font-black ${balance >= 0 ? 'text-blue-500' : 'text-rose-500'}`;

        document.getElementById("budgetInput").value = this.data.budget || "";
        if(this.data.budget > 0) {
            const percent = Math.min((totalExp / this.data.budget) * 100, 100);
            document.getElementById("budgetBar").style.width = `${percent}%`;
            document.getElementById("budgetBar").className = `h-5 rounded-full transition-all duration-1000 relative ${percent > 90 ? 'bg-rose-500' : percent > 50 ? 'bg-yellow-500' : 'bg-blue-500'}`;
            document.getElementById("budgetPercent").textContent = `${Math.round(percent)}%`;
            document.getElementById("budgetUsed").textContent = `${formatter.format(totalExp)} Gastados`;
        }

        const searchTerm = document.getElementById("searchInput")?.value.toLowerCase() || "";
        const filtered = this.data.records.filter(r => r.desc.toLowerCase().includes(searchTerm) || r.category.toLowerCase().includes(searchTerm));
        
        const tbody = document.getElementById("historyTable");
        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-12 opacity-30 font-bold text-lg">SIN MOVIMIENTOS</td></tr>`;
        } else {
            tbody.innerHTML = filtered.map(r => `
                <tr class="hover:bg-slate-50 dark:hover:bg-white/5 transition-all group border-b border-white/5 last:border-0">
                    <td class="px-6 py-4 opacity-70 text-xs font-bold">${r.date}</td>
                    <td class="px-6 py-4 font-bold flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center ${r.type === 'income' ? 'bg-emerald-500/20 text-emerald-500' : 'bg-rose-500/20 text-rose-500'}">
                            <i data-lucide="${r.type === 'income' ? 'arrow-up' : 'shopping-bag'}" class="w-4 h-4"></i>
                        </div>
                        ${r.desc}
                    </td>
                    <td class="px-6 py-4"><span class="px-3 py-1 rounded-lg text-xs font-bold bg-slate-200 dark:bg-white/10 opacity-80">${r.category}</span></td>
                    <td class="px-6 py-4 text-right font-black ${r.type === 'income' ? 'text-emerald-500' : 'text-rose-500'}">${r.type === 'income' ? '+' : '-'}${formatter.format(r.amount)}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="app.deleteRecord(${r.id})" class="text-slate-400 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        if(searchTerm === "") this.updateCharts(totalInc, totalExp);
        lucide.createIcons();
    },

    async fetchDolarSimple() {
        try {
            const res = await fetch("https://dolarapi.com/v1/dolares/blue");
            const data = await res.json();
            document.getElementById("dolarRateTag").textContent = `@ $${data.venta}`;
            const totalInc = this.data.records.filter(r => r.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
            const totalExp = this.data.records.filter(r => r.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);
            const balance = totalInc - totalExp;
            if(data.venta > 0) document.getElementById("capitalUsd").textContent = `US$ ${(balance / data.venta).toLocaleString('en-US', {maximumFractionDigits: 0})}`;
        } catch(e) {}
    },

    // --- MERCADO FOREX GLOBAL ---
    async fetchFullMarket() {
        const gridArg = document.getElementById("marketGridArg");
        const gridWorld = document.getElementById("marketGridWorld");
        const icon = document.getElementById("refreshIcon");
        icon.classList.add("animate-spin");

        // 1. ARGENTINA (Solo Blue y Oficial)
        try {
            const res = await fetch("https://dolarapi.com/v1/dolares");
            const data = await res.json();
            // Filtramos solo Oficial y Blue
            const filtered = data.filter(d => d.casa === "oficial" || d.casa === "blue");
            
            gridArg.innerHTML = filtered.map(d => `
                <div class="glass p-6 rounded-3xl relative overflow-hidden group hover:bg-white/5 transition-all border border-emerald-500/30">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-emerald-500/10 rounded-full blur-2xl group-hover:bg-emerald-500/20 transition-all"></div>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-3 rounded-xl bg-emerald-500/20 text-emerald-400"><i data-lucide="dollar-sign" class="w-6 h-6"></i></div>
                        <h3 class="font-bold text-lg text-slate-200">D贸lar ${d.nombre}</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-2">
                        <div class="bg-black/20 p-3 rounded-xl">
                            <p class="text-[10px] uppercase font-bold text-slate-500 mb-1">Compra</p>
                            <p class="text-xl font-black text-white">$${d.compra}</p>
                        </div>
                        <div class="bg-black/20 p-3 rounded-xl border border-emerald-500/20">
                            <p class="text-[10px] uppercase font-bold text-slate-500 mb-1">Venta</p>
                            <p class="text-xl font-black text-emerald-400">$${d.venta}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (e) { console.error(e); }

        // 2. MUNDO (API FRANKFURTER - Gratis y sin Key)
        try {
            // Base USD
            const res = await fetch("https://api.frankfurter.app/latest?from=USD");
            const data = await res.json();
            const rates = data.rates;
            
            const currencies = [
                {code: 'EUR', name: 'Euro', flag: ''},
                {code: 'GBP', name: 'Libra Esterlina', flag: ''},
                {code: 'JPY', name: 'Yen Japon茅s', flag: ''},
                {code: 'BRL', name: 'Real Brasil', flag: 'ю'},
                {code: 'CLP', name: 'Peso Chileno', flag: ''},
                {code: 'UYU', name: 'Peso Uruguayo', flag: '吼'}, // A veces no est谩 en Frankfurter, depende disponibilidad
                {code: 'MXN', name: 'Peso Mexicano', flag: '拆'},
                {code: 'CAD', name: 'D贸lar Canad谩', flag: ''},
                {code: 'AUD', name: 'D贸lar Austral', flag: ''},
                {code: 'CNY', name: 'Yuan Chino', flag: ''},
                {code: 'CHF', name: 'Franco Suizo', flag: ''},
                {code: 'KRW', name: 'Won Coreano', flag: '梆'},
                {code: 'INR', name: 'Rupia India', flag: ''},
                {code: 'RUB', name: 'Rublo Ruso', flag: '佛'},
                {code: 'ZAR', name: 'Rand Sudaf.', flag: '筐'},
                {code: 'NZD', name: 'D贸lar NZ', flag: '仇'},
                {code: 'SGD', name: 'D贸lar Singapur', flag: '葛'},
                {code: 'HKD', name: 'D贸lar HK', flag: ''},
                {code: 'TRY', name: 'Lira Turca', flag: '桂'},
                {code: 'ILS', name: 'Shekel Israel', flag: ''}
            ];

            gridWorld.innerHTML = currencies.map(c => {
                const val = rates[c.code];
                if(!val) return ''; 
                return `
                <div class="glass p-4 rounded-2xl hover:bg-white/5 transition-all border border-blue-500/10 hover:border-blue-500/40 group">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-2xl">${c.flag}</span>
                        <span class="text-xs font-bold text-slate-500 bg-black/30 px-2 py-1 rounded">${c.code}</span>
                    </div>
                    <p class="text-sm font-bold text-slate-300 truncate">${c.name}</p>
                    <p class="text-lg font-mono font-bold text-blue-400 mt-1">${val.toFixed(2)}</p>
                    <p class="text-[10px] text-slate-600">1 USD = ${val.toFixed(2)} ${c.code}</p>
                </div>`;
            }).join('');

        } catch (e) { 
            console.error(e);
            gridWorld.innerHTML = `<div class="col-span-full text-center text-slate-500 p-4">Datos internacionales no disponibles moment谩neamente.</div>`;
        }

        setTimeout(() => icon.classList.remove("animate-spin"), 1000);
        lucide.createIcons();
    },

    exportProExcel() {
        const wb = XLSX.utils.book_new();
        const headerStyle = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "0F172A" } }, alignment: { horizontal: "center", vertical: "center" } };
        const titleStyle = { font: { bold: true, sz: 18, color: { rgb: "3B82F6" } } };
        const moneyGreen = { numFmt: "$ #,##0", font: { color: { rgb: "10B981" } } };
        const moneyRed = { numFmt: "$ #,##0", font: { color: { rgb: "EF4444" } } };

        const totalInc = this.data.records.filter(r => r.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
        const totalExp = this.data.records.filter(r => r.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);
        const wsDash = XLSX.utils.aoa_to_sheet([["REPORTE CFO"],["Generado por:", this.user],[""],["Ingresos", totalInc],["Gastos", totalExp],["Balance", totalInc - totalExp]]);
        wsDash['A1'].s = titleStyle;
        XLSX.utils.book_append_sheet(wb, wsDash, "Resumen");

        const transData = [["FECHA", "DESCRIPCIN", "CATEGORA", "TIPO", "MONTO"], ...this.data.records.map(r => [r.date, r.desc, r.category, r.type.toUpperCase(), r.amount])];
        const wsTrans = XLSX.utils.aoa_to_sheet(transData);
        wsTrans['A1'].s = wsTrans['B1'].s = wsTrans['C1'].s = wsTrans['D1'].s = wsTrans['E1'].s = headerStyle;
        
        for (let i = 1; i < transData.length; i++) {
            wsTrans[XLSX.utils.encode_cell({ r: i, c: 4 })].s = transData[i][3] === 'GASTO' ? moneyRed : moneyGreen;
        }

        XLSX.utils.book_append_sheet(wb, wsTrans, "Detalle");
        XLSX.writeFile(wb, `FORJAX_CFO_${this.user}.xlsx`);
    },

    updateCharts(inc, exp) {
        const ctxBar = document.getElementById("barChart").getContext("2d");
        const ctxPie = document.getElementById("pieChart").getContext("2d");
        if (this.charts.bar) this.charts.bar.destroy();
        if (this.charts.pie) this.charts.pie.destroy();
        const c = { bg: this.theme === 'dark' ? '#94a3b8' : '#475569' };
        this.charts.bar = new Chart(ctxBar, { type: 'bar', data: { labels: ['Ingresos', 'Gastos'], datasets: [{ data: [inc, exp], backgroundColor: ['#10b981', '#f43f5e'], borderRadius: 6, barThickness: 40 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: c.bg } }, x: { grid: { display: false }, ticks: { color: c.bg } } } } });
        const catData = {}; this.data.records.filter(r => r.type === 'expense').forEach(r => { catData[r.category] = (catData[r.category] || 0) + r.amount; });
        this.charts.pie = new Chart(ctxPie, { type: 'doughnut', data: { labels: Object.keys(catData), datasets: [{ data: Object.values(catData), backgroundColor: ['#3b82f6', '#8b5cf6', '#f59e0b', '#ec4899', '#64748b'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: c.bg, boxWidth: 10, font: {size:10} } } }, cutout: '75%' } });
    },

    toggleTheme() { this.theme = this.theme === 'dark' ? 'light' : 'dark'; localStorage.setItem("theme", this.theme); this.init(); },
    applyTheme() { document.documentElement.className = this.theme; document.getElementById("themeIcon").setAttribute('data-lucide', this.theme === 'dark' ? 'sun' : 'moon'); },
    initSession() { const v = document.getElementById("userInput").value; if(v.length>2) { localStorage.setItem("currentUser", v); location.reload(); } },
    logout() { localStorage.removeItem("currentUser"); location.reload(); }
};

app.init();
</script>
</body>
</html>
