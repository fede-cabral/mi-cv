<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORJAX Terminal - V31 OMEGA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.6.6/css/flag-icons.min.css"/>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { dark: '#050b14', neon: '#00f3ff' },
                    boxShadow: { 'neon-blue': '0 0 20px rgba(0, 243, 255, 0.4)' }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #050b14; color: #f8fafc; overflow-x: hidden; }
        .glass { background: rgba(10, 15, 30, 0.8); backdrop-filter: blur(15px); border: 1px solid rgba(0, 243, 255, 0.1); }
        .glass-card { background: #0f172a; border: 1px solid rgba(255,255,255,0.08); transition: all 0.3s ease; }
        .glass-card:hover { border-color: #00f3ff; transform: translateY(-2px); }
        .nav-container { position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%); z-index: 50; padding: 0.4rem; border-radius: 999px; display: flex; gap: 0.3rem; background: rgba(5, 11, 20, 0.9); border: 1px solid rgba(255,255,255,0.1); }
        .nav-btn { padding: 0.6rem 1.2rem; border-radius: 999px; font-weight: 800; font-size: 0.75rem; color: #94a3b8; transition: all 0.3s; display: flex; align-items: center; gap: 0.5rem; }
        .nav-btn.active { background: #00f3ff; color: #050b14; box-shadow: 0 0 15px rgba(0, 243, 255, 0.5); }
        .blur-sensitive { transition: filter 0.3s; }
        body.privacy-active .blur-sensitive { filter: blur(10px); }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>

<body class="min-h-screen pb-20">

<div id="loginScreen" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#050b14]">
    <div class="glass p-10 rounded-3xl border-2 border-cyan-500/20 w-full max-w-md text-center">
        <img src="forjax_logo_metal.png" class="h-24 mx-auto mb-8 drop-shadow-neon">
        <input id="userInput" type="text" placeholder="ACCESS ID" onkeydown="if(event.key==='Enter') app.initSession()" class="w-full p-4 rounded-xl bg-slate-900 border border-slate-700 text-center font-bold text-white mb-4 outline-none focus:border-cyan-400">
        <button onclick="app.initSession()" class="w-full bg-cyan-400 text-black font-black py-4 rounded-xl hover:bg-cyan-300 transition-all">INICIAR SISTEMA</button>
    </div>
</div>

<div id="mainApp" class="hidden opacity-0 transition-opacity duration-500">
    <nav class="nav-container">
        <button onclick="app.switchTab('wallet')" id="btnWallet" class="nav-btn active"><i data-lucide="wallet" class="w-4 h-4"></i> WALLET</button>
        <button onclick="app.switchTab('subs')" id="btnSubs" class="nav-btn"><i data-lucide="zap" class="w-4 h-4"></i> SUBS</button>
        <button onclick="app.switchTab('goals')" id="btnGoals" class="nav-btn"><i data-lucide="crosshair" class="w-4 h-4"></i> METAS</button>
        <button onclick="app.switchTab('market')" id="btnMarket" class="nav-btn"><i data-lucide="globe" class="w-4 h-4"></i> MARKET</button>
        <button onclick="app.togglePrivacy()" class="nav-btn px-3"><i data-lucide="eye" class="w-4 h-4"></i></button>
        <button onclick="app.logout()" class="nav-btn px-3 hover:text-rose-500"><i data-lucide="power" class="w-4 h-4"></i></button>
    </nav>

    <div class="pt-28 max-w-7xl mx-auto px-6">
        <div id="viewWallet" class="space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="glass-card p-6 rounded-2xl">
                    <p class="text-[10px] font-bold text-emerald-400 mb-1 uppercase tracking-widest">INGRESOS</p>
                    <h2 class="text-3xl font-black blur-sensitive" id="bIncome">$0</h2>
                </div>
                <div class="glass-card p-6 rounded-2xl">
                    <p class="text-[10px] font-bold text-rose-400 mb-1 uppercase tracking-widest">GASTOS</p>
                    <h2 class="text-3xl font-black blur-sensitive" id="bExpense">$0</h2>
                </div>
                <div class="glass-card p-6 rounded-2xl border-l-4 border-cyan-400">
                    <p class="text-[10px] font-bold text-cyan-400 mb-1 uppercase tracking-widest">BALANCE</p>
                    <h2 class="text-3xl font-black blur-sensitive" id="bNet">$0</h2>
                </div>
                <div class="glass-card p-6 rounded-2xl">
                    <p class="text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-widest">DOLAR BLUE</p>
                    <h2 class="text-2xl font-black" id="dolarVal">...</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 glass p-8 rounded-3xl space-y-4">
                    <h3 class="font-bold flex items-center gap-2"><i data-lucide="plus-circle" class="text-cyan-400"></i> NUEVO REGISTRO</h3>
                    <input id="transDesc" type="text" placeholder="Concepto" class="w-full p-4 rounded-xl bg-slate-900 border border-slate-800">
                    <input id="transAmount" type="number" placeholder="Monto $" class="w-full p-4 rounded-xl bg-slate-900 border border-slate-800 font-mono">
                    <select id="transCategory" onchange="app.checkCustomCategory()" class="w-full p-4 rounded-xl bg-slate-900 border border-slate-800"></select>
                    <input id="customCategoryInput" type="text" placeholder="Nueva categor√≠a..." class="w-full p-4 rounded-xl bg-slate-900 border border-cyan-500 hidden">
                    <select id="transBio" class="w-full p-4 rounded-xl bg-slate-900 border border-slate-800">
                        <option value="100">üßò Zen</option>
                        <option value="70">üòê Normal</option>
                        <option value="30">üî• Estr√©s</option>
                    </select>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="app.addRecord('income')" class="bg-emerald-500/20 text-emerald-400 p-4 rounded-xl font-bold hover:bg-emerald-500 hover:text-black transition-all">INGRESO</button>
                        <button onclick="app.addRecord('expense')" class="bg-rose-500/20 text-rose-400 p-4 rounded-xl font-bold hover:bg-rose-500 hover:text-black transition-all">GASTO</button>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-64">
                        <div class="glass p-4 rounded-3xl"><canvas id="lineChart"></canvas></div>
                        <div class="glass p-4 rounded-3xl"><canvas id="doughnutChart"></canvas></div>
                    </div>
                    <div class="glass rounded-3xl overflow-hidden">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-900 text-[10px] uppercase text-slate-500 font-bold">
                                <tr>
                                    <th class="p-4">Fecha</th>
                                    <th class="p-4">Detalle</th>
                                    <th class="p-4 text-right">Monto</th>
                                    <th class="p-4 text-center">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="viewSubs" class="hidden space-y-8">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-black">SUSCRIPCIONES</h2>
                <button onclick="app.toggleSubForm()" class="bg-cyan-500 text-black px-6 py-2 rounded-xl font-bold">+ NUEVA</button>
            </div>
            <div id="subForm" class="hidden glass p-6 rounded-3xl grid grid-cols-1 md:grid-cols-4 gap-4">
                <input id="subName" placeholder="Nombre" class="p-4 rounded-xl bg-slate-900">
                <input id="subAmount" type="number" placeholder="Monto $" class="p-4 rounded-xl bg-slate-900">
                <input id="subDay" type="number" placeholder="D√≠a (1-31)" class="p-4 rounded-xl bg-slate-900">
                <button onclick="app.addSub()" class="bg-cyan-400 text-black rounded-xl font-bold">GUARDAR</button>
            </div>
            <div id="subsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
        </div>

        <div id="viewGoals" class="hidden space-y-8">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-black">METAS DE AHORRO</h2>
                <button onclick="app.addGoalPrompt()" class="bg-purple-500 text-white px-6 py-2 rounded-xl font-bold">+ NUEVA META</button>
            </div>
            <div id="goalsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
        </div>

        <div id="viewMarket" class="hidden space-y-8">
             <h2 class="text-3xl font-black text-center">MERCADO EN VIVO</h2>
             <div id="marketGrid" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
        </div>
    </div>
</div>

<script>
const app = {
    audioCtx: null,
    user: localStorage.getItem("currentUser"),
    theme: 'dark',
    data: { records: [], subs: [], goals: [] },
    charts: {},
    rates: { ARS: 1, USD: 1 },
    categories: ["Hogar", "Comida", "Salud", "Transporte", "Ocio", "Servicios", "Otros"],

    // --- FORMATEADOR PARA N√öMEROS WHALE ---
    fNum(n) {
        if (n >= 1e9) return (n / 1e9).toFixed(2) + ' B';
        if (n >= 1e6) return (n / 1e6).toFixed(2) + ' M';
        if (n >= 1e3) return (n / 1e3).toFixed(1) + ' K';
        return n.toLocaleString('es-AR');
    },

    init() {
        if (!this.user) return;
        document.getElementById("loginScreen").classList.add("hidden");
        document.getElementById("mainApp").classList.remove("hidden");
        setTimeout(() => document.getElementById("mainApp").classList.remove("opacity-0"), 100);
        
        this.loadData();
        this.updateCategoryDropdown();
        this.fetchMarket();
        this.render();
        this.renderSubs();
        this.renderGoals();
        lucide.createIcons();
    },

    initSession() {
        const name = document.getElementById("userInput").value.trim();
        if (name.length > 2) {
            localStorage.setItem("currentUser", name);
            location.reload();
        } else {
            Swal.fire('Error', 'ID muy corto', 'error');
        }
    },

    loadData() {
        const p = this.user + "_";
        this.data.records = JSON.parse(localStorage.getItem(p+"records")) || [];
        this.data.subs = JSON.parse(localStorage.getItem(p+"subs")) || [];
        this.data.goals = JSON.parse(localStorage.getItem(p+"goals")) || [];
    },

    save() {
        const p = this.user + "_";
        localStorage.setItem(p+"records", JSON.stringify(this.data.records));
        localStorage.setItem(p+"subs", JSON.stringify(this.data.subs));
        localStorage.setItem(p+"goals", JSON.stringify(this.data.goals));
        this.render();
    },

    addRecord(type) {
        const d = document.getElementById("transDesc").value;
        const a = parseFloat(document.getElementById("transAmount").value);
        let c = document.getElementById("transCategory").value;
        const b = parseInt(document.getElementById("transBio").value);

        if (c === 'custom') c = document.getElementById("customCategoryInput").value;
        if (!d || isNaN(a)) return;

        this.data.records.unshift({ id: Date.now(), date: new Date().toLocaleDateString('es-AR'), desc: d, amount: a, category: c, type, bio: b });
        this.save();
        document.getElementById("transDesc").value = "";
        document.getElementById("transAmount").value = "";
    },

    deleteRecord(id) {
        this.data.records = this.data.records.filter(r => r.id !== id);
        this.save();
    },

    render() {
        const rec = this.data.records;
        const inc = rec.filter(r => r.type === 'income').reduce((s, r) => s + r.amount, 0);
        const exp = rec.filter(r => r.type === 'expense').reduce((s, r) => s + r.amount, 0);

        document.getElementById("bIncome").innerText = `$ ${this.fNum(inc)}`;
        document.getElementById("bExpense").innerText = `$ ${this.fNum(exp)}`;
        document.getElementById("bNet").innerText = `$ ${this.fNum(inc - exp)}`;

        const tb = document.getElementById("historyTable");
        tb.innerHTML = rec.slice(0, 20).map(r => `
            <tr class="border-b border-white/5 hover:bg-white/5">
                <td class="p-4 text-slate-500 font-mono text-xs">${r.date}</td>
                <td class="p-4 font-bold">${r.desc} ${r.bio < 50 ? 'üî•' : ''}</td>
                <td class="p-4 text-right font-black ${r.type==='income'?'text-emerald-400':'text-rose-400'}">$ ${this.fNum(r.amount)}</td>
                <td class="p-4 text-center"><button onclick="app.deleteRecord(${r.id})" class="text-slate-600 hover:text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
            </tr>
        `).join('');
        this.updateCharts(rec);
        lucide.createIcons();
    },

    // --- SUBSCRIPTIONS ---
    toggleSubForm() { document.getElementById("subForm").classList.toggle("hidden"); },
    addSub() {
        const n = document.getElementById("subName").value;
        const a = parseFloat(document.getElementById("subAmount").value);
        const d = document.getElementById("subDay").value;
        if (n && a) {
            this.data.subs.push({ id: Date.now(), name: n, amount: a, day: d });
            this.save(); this.renderSubs(); this.toggleSubForm();
        }
    },
    renderSubs() {
        const grid = document.getElementById("subsGrid");
        grid.innerHTML = this.data.subs.map(s => `
            <div class="glass-card p-6 rounded-2xl">
                <h4 class="font-bold text-cyan-400">${s.name}</h4>
                <p class="text-2xl font-black mb-2">$ ${this.fNum(s.amount)}</p>
                <p class="text-[10px] text-slate-500 font-mono uppercase tracking-widest">D√≠a de cobro: ${s.day}</p>
                <button onclick="app.deleteSub(${s.id})" class="mt-4 text-rose-500 text-xs font-bold uppercase">Eliminar</button>
            </div>
        `).join('');
    },
    deleteSub(id) { this.data.subs = this.data.subs.filter(s=>s.id!==id); this.save(); this.renderSubs(); },

    // --- GOALS ---
    addGoalPrompt() {
        Swal.fire({
            title: 'Nueva Meta',
            html: `<input id="sw-name" class="swal2-input" placeholder="Nombre"><input id="sw-target" type="number" class="swal2-input" placeholder="Monto Objetivo">`,
            preConfirm: () => ({ name: document.getElementById("sw-name").value, target: document.getElementById("sw-target").value })
        }).then(res => {
            if (res.value.name) {
                this.data.goals.push({ id: Date.now(), name: res.value.name, target: parseFloat(res.value.target), current: 0 });
                this.save(); this.renderGoals();
            }
        });
    },
    renderGoals() {
        const grid = document.getElementById("goalsGrid");
        grid.innerHTML = this.data.goals.map(g => {
            const pct = Math.min((g.current / g.target) * 100, 100);
            return `
            <div class="glass-card p-6 rounded-2xl">
                <div class="flex justify-between mb-2"><span class="font-bold">${g.name}</span><span class="font-mono text-cyan-400">${pct.toFixed(1)}%</span></div>
                <div class="w-full bg-slate-800 h-2 rounded-full mb-4"><div class="bg-cyan-400 h-full rounded-full" style="width:${pct}%"></div></div>
                <p class="text-xs text-slate-400">$ ${this.fNum(g.current)} / $ ${this.fNum(g.target)}</p>
                <div class="flex gap-2 mt-4">
                    <button onclick="app.depositGoal(${g.id})" class="flex-1 bg-cyan-400/10 text-cyan-400 py-2 rounded-lg text-xs font-bold">+ DEP</button>
                    <button onclick="app.deleteGoal(${g.id})" class="text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>`;
        }).join('');
        lucide.createIcons();
    },
    depositGoal(id) {
        const g = this.data.goals.find(x => x.id === id);
        Swal.fire({ title: 'Depositar', input: 'number' }).then(res => {
            if (res.value) { g.current += parseFloat(res.value); this.save(); this.renderGoals(); if(g.current >= g.target) confetti(); }
        });
    },
    deleteGoal(id) { this.data.goals = this.data.goals.filter(g=>g.id!==id); this.save(); this.renderGoals(); },

    // --- MARKET ---
    async fetchMarket() {
        try {
            const r = await fetch("https://dolarapi.com/v1/dolares/blue");
            const d = await r.json();
            document.getElementById("dolarVal").innerText = `$ ${d.venta}`;
        } catch(e) {}
    },

    // --- UTILS ---
    switchTab(tab) {
        document.querySelectorAll('[id^="view"]').forEach(v => v.classList.add('hidden'));
        document.getElementById('view' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
    },
    togglePrivacy() { document.body.classList.toggle("privacy-active"); },
    logout() { localStorage.removeItem("currentUser"); location.reload(); },
    updateCategoryDropdown() {
        const sel = document.getElementById("transCategory");
        sel.innerHTML = this.categories.map(c => `<option value="${c}">${c}</option>`).join('') + `<option value="custom">‚úèÔ∏è Nuevo...</option>`;
    },
    checkCustomCategory() {
        const val = document.getElementById('transCategory').value;
        document.getElementById('customCategoryInput').classList.toggle('hidden', val !== 'custom');
    },

    updateCharts(records) {
        if (!window.Chart) return;
        if (this.charts.line) this.charts.line.destroy();
        if (this.charts.doughnut) this.charts.doughnut.destroy();

        // Line Chart
        const dates = [...new Set(records.map(r => r.date))].slice(-7).sort();
        const data = dates.map(d => records.filter(r => r.date === d).reduce((s, r) => s + (r.type === 'income' ? r.amount : -r.amount), 0));
        this.charts.line = new Chart(document.getElementById("lineChart"), {
            type: 'line',
            data: { labels: dates, datasets: [{ data, borderColor: '#00f3ff', tension: 0.4, fill: true, backgroundColor: 'rgba(0,243,255,0.05)' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false }, scales: { y: { ticks: { callback: v => this.fNum(v) }, grid: { color: '#ffffff05' } }, x: { display: false } } }
        });

        // Doughnut Chart
        const cats = {}; records.filter(r => r.type === 'expense').forEach(r => cats[r.category] = (cats[r.category] || 0) + r.amount);
        this.charts.doughnut = new Chart(document.getElementById("doughnutChart"), {
            type: 'doughnut',
            data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#00f3ff', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 9 } } } } }
        });
    },

    initAudio() { /* Placeholder para no romper clics */ }
};

// --- SINGLE INIT ---
document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>
